use crate::{
    domain::definition::NTTDomain, ConfigZZVec202753_512, ConfigZZp, ConfigZZpX,
    ConfigZZpX202753_512, Polynomial, Vector, ZZVec, ZZpX,
};

impl NTTDomain<ConfigZZpX202753_512, ConfigZZVec202753_512> for ZZVec<ConfigZZVec202753_512> {
    const ONE_OVER_N: u32 = 202357;

    type Polynomial = ZZpX<ConfigZZpX202753_512>;

    type Table = [u32; ConfigZZpX202753_512::DIM * 2];

    /// Get the forward table
    fn table() -> Self::Table {
        [
            1, 7979, 35197, 23958, 18435, 96940, 47095, 69696, 157471, 768, 50779, 65147, 163184,
            168123, 264, 78926, 155504, 120809, 159806, 181210, 194326, 74963, 22520, 47922, 79562,
            5555, 122031, 65443, 10268, 16160, 96950, 61355, 53530, 118052, 114534, 59015, 26699,
            140671, 167301, 171680, 169408, 154934, 93152, 170063, 32021, 26779, 141963, 144519,
            104705, 98835, 63357, 62274, 28115, 84767, 129015, 33704, 127095, 123252, 23276,
            200209, 185410, 100502, 67712, 140056, 90379, 144373, 77846, 100795, 115464, 180377,
            5276, 127333, 27427, 69546, 41086, 176346, 153516, 73291, 137955, 199661, 66315,
            144808, 199272, 2262, 119188, 89482, 100466, 135605, 98853, 38917, 87561, 165134,
            11091, 94781, 70402, 111748, 98537, 153342, 116724, 96267, 65468, 77444, 192104,
            187889, 32837, 49547, 71789, 27206, 132390, 199433, 61384, 134441, 42426, 122297,
            194830, 41319, 104989, 134588, 124408, 175497, 153296, 142688, 99229, 200479, 40446,
            138611, 49049, 48681, 156766, 52657, 175513, 3256, 142701, 153184, 49781, 9472, 110024,
            163759, 135181, 165992, 154181, 107748, 24612, 114244, 138615, 194223, 189469, 46783,
            71466, 85778, 35084, 136096, 62944, 10995, 160690, 138291, 17221, 142578, 98820,
            181116, 142816, 57004, 42376, 128853, 65255, 202694, 197004, 153660, 15576, 196068,
            187113, 104288, 45312, 35849, 194119, 45334, 112162, 191609, 165004, 91687, 31376,
            151902, 148234, 100837, 42966, 173144, 142428, 2447, 124992, 171914, 8830, 99279,
            177427, 68587, 105719, 79421, 55349, 33637, 67929, 46722, 40964, 13920, 33325, 90992,
            119168, 132655, 4785, 61951, 182721, 136789, 108630, 192448, 126046, 66154, 2669, 6886,
            174855, 24652, 6873, 96357, 84731, 90147, 185883, 22262, 108531, 10786, 99087, 81226,
            2381, 141970, 67068, 70405, 29225, 20325, 66356, 66441, 48154, 3831, 64011, 8962,
            47657, 93328, 7860, 64263, 28046, 142475, 133458, 2626, 98658, 105036, 117748, 156643,
            65820, 47510, 10762, 105479, 80089, 155428, 17574, 120623, 196122, 9784, 180149, 92854,
            52813, 74193, 19657, 115134, 190502, 178970, 57184, 76886, 56831, 98841, 122362, 70703,
            54734, 195377, 116345, 113521, 122487, 54313, 37900, 99377, 190437, 65841, 202415,
            141640, 154738, 91485, 165053, 77152, 63073, 26521, 37784, 187578, 94811, 25526,
            153893, 40079, 109925, 184850, 97479, 24433, 57418, 119195, 102195, 144092, 130170,
            125564, 186702, 68967, 102596, 99623, 40482, 20349, 77276, 13331, 154630, 40765, 81631,
            91113, 156297, 162813, 34719, 62303, 12312, 104996, 177754, 41931, 58217, 6320, 1004,
            103549, 58766, 128978, 189953, 56312, 198319, 102889, 36492, 16360, 171422, 4400,
            141526, 104497, 54918, 41489, 6206, 45942, 67601, 65399, 177527, 55475, 178618, 42185,
            74072, 198246, 114110, 122720, 176083, 90720, 42400, 117596, 14575, 116456, 31185,
            47184, 121140, 52509, 71743, 65678, 94358, 60593, 24386, 135767, 20935, 174646, 44793,
            152561, 97766, 84123, 148739, 75172, 158155, 186826, 200673, 29426, 202038, 174852,
            178270, 104035, 66756, 13993, 109168, 24584, 138903, 59139, 188555, 53085, 201726,
            118440, 145468, 131000, 126037, 197096, 91402, 196770, 74177, 22276, 160241, 2521,
            86763, 83235, 134378, 44198, 85635, 4055, 171750, 188476, 46367, 140821, 20402, 179652,
            129808, 75708, 16074, 114550, 119574, 128081, 102057, 56755, 173506, 6890, 173075,
            14742, 154535, 93772, 116417, 79750, 182811, 43887, 32312, 118385, 163172, 72375,
            186159, 196936, 6998, 79967, 166464, 184106, 57222, 177335, 97185, 111643, 19503,
            102886, 128186, 109962, 56736, 151848, 22695, 24976, 41641, 144125, 139593, 90318,
            28977, 69063, 55879, 4694, 15138, 148067, 180055, 153840, 80902, 154259, 44562, 134189,
            118149, 112174, 26323, 181862, 104089, 49843, 76576, 105115, 20393, 107841, 26801,
            143517, 40893, 55670, 170127, 11998, 179001, 56847, 154228, 77255, 78360, 146941,
            190614, 58853, 136152, 6234, 74789, 39352, 82733, 165592, 14815, 3886, 202470, 174979,
            176899, 113488, 54473, 140388, 53813, 145826, 41367, 188162, 25006, 13922, 46612,
            68146, 128041, 169525, 192522, 76310, 191574, 14079, 154558, 74536, 114936, 22525,
            192290, 49959, 135990, 132907, 135451, 90039, 137558, 73293, 57485, 45529, 27358,
            127254, 148797, 132448, 98019, 75280, 109997, 151079, 198627, 127385, 61942, 126157,
            172318, 57229, 173176, 9609, 114986, 15969, 153575, 138546, 187048, 193912, 122149,
            195953, 103741, 111693, 41997, 146107, 99039, 103740, 172374, 98547, 69659, 63188,
            169674, 47065, 128916, 54795, 145526, 188276, 132336, 174073, 146867, 142206, 90064,
            64024, 88884, 178195, 174111, 170866, 129547, 20719, 156295, 146855, 4515, 137904,
            158856, 103021, 105295, 143126, 148781, 4784, 93943, 196109, 15847, 128094, 125832,
            183425, 175125, 151452, 33767, 170909, 161766, 5316, 42935, 128548, 65086, 70761,
            158622, 60712, 11926, 66397, 92804, 29160, 71558, 8834, 6374, 169896, 100860, 35283,
            110703, 107169, 109090, 10481, 38129, 101791, 4306, 92317, 166217, 38070, 104687,
            157966, 87170, 86640, 64094, 62960, 161425, 123019, 131159, 109428, 106037, 183707,
            109818, 142109, 50422, 55186, 6125, 7902, 29112, 132463, 144155, 197729, 195282,
            201026, 13854, 40681, 133672, 88108, 172772, 30141, 186111, 16697, 4943, 106115, 52558,
            67078, 168307, 88434, 152896, 195136, 10386, 146670, 90375, 112457, 139811, 4963,
            41724, 198123, 19649, 51302, 5802, 66474, 40723, 118511, 109039, 9058, 136899, 86710,
            70903, 54167, 88967, 29440, 150967, 10120, 37628, 159372, 166862, 115700, 98416,
            201648, 135207, 170693, 65116, 107378, 194725, 14536, 76166, 77773, 13510, 134447,
            55685, 78792, 190520, 119839, 82471, 102624, 148734, 35277, 110891, 187950, 104183,
            191610, 141046, 126884, 137189, 170337, 78538, 147932, 42198, 127862, 77281, 53226,
            159622, 132345, 132657, 99543, 97520, 148819, 5903, 61341, 173102, 27422, 146197,
            67854, 59700, 79503, 131561, 72938, 26216, 139121, 198402, 156887, 43149, 11277, 95383,
            128948, 51796, 69670, 111589, 80208, 57643, 89693, 114153, 60311, 20232, 39740, 37168,
            138586, 137067, 7911, 42317, 63598, 122259, 59878, 123104, 111284, 6942, 38649, 20209,
            58976, 38627, 20273, 95654, 60974, 3794, 62129, 125944, 63308, 195358, 199171, 53037,
            36712, 134636, 75250, 40176, 11811, 115187, 200477, 190604, 181816, 173699, 127566,
            72494, 178070, 62936, 149916, 81867, 149380, 161764, 192111, 100515, 121070, 28216,
            79634, 34358, 20426, 12269, 167405, 170856, 151605, 109420, 7762, 165258, 90823,
            181115, 95954, 150335, 36217, 121374, 94818, 197721, 197519, 175599, 81191, 38304,
            78845, 13167, 33439, 148294, 174071, 93236, 29287, 70187, 18287, 68479, 177359, 130452,
            145359, 42603, 115309, 139356, 24072, 123936, 58963, 147350, 143756, 45749, 75871,
            165980, 174577, 133088, 91691, 95777, 28626, 185390, 143675, 174784, 66402, 60082,
            86186, 195117, 101009, 157985, 46914, 97020, 11626, 109383, 118045, 79487, 15389,
            50548, 46775, 183134, 188068, 202345, 191369, 35087, 160033, 166834, 95041, 126665,
            139083, 24533, 92162, 165727, 183420, 87888, 138478, 194168, 30799, 16057, 181660,
            85618, 71165, 94221, 183988, 68469, 97569, 181937, 166596, 88590, 62652, 95655, 68953,
            55470, 188084, 57084, 89998, 106071, 49487, 165382, 66454, 114377, 22830, 20309, 45864,
            111548, 158575, 166781, 77660, 86001, 85827, 61243, 23167, 102728, 139086, 169255,
            150665, 182342, 154043, 50008, 198681, 32783, 24187, 47096, 77675, 132137, 5523, 26414,
            96939, 71053, 34499, 157735, 79694, 16149, 104716, 163952, 10652, 65411, 28147, 178024,
            168731, 32016, 189637, 112382, 122212, 977, 90869, 176512, 66910, 138191, 55175, 15823,
            139351, 162393, 142077, 18078, 86979, 52452, 32316, 144751, 87141, 23563, 57146,
            108618, 96700, 119931, 138042, 186955, 60124, 109273, 51367, 30967, 132539, 148124,
            34159, 126950, 182815, 191289, 173100, 194807, 60555, 123778, 14799, 105909, 176160,
            65168, 116780,
        ]
    }

    /// Get the reverse table
    fn inv_table() -> Self::Table {
        [
            1, 194774, 178795, 167556, 133057, 155658, 105813, 184318, 123827, 202489, 34630,
            39569, 137606, 151974, 201985, 45282, 141398, 105803, 186593, 192485, 137310, 80722,
            197198, 123191, 154831, 180233, 127790, 8427, 21543, 42947, 81944, 47249, 62697,
            135041, 102251, 17343, 2544, 179477, 79501, 75658, 169049, 73738, 117986, 174638,
            140479, 139396, 103918, 98048, 58234, 60790, 175974, 170732, 32690, 109601, 47819,
            33345, 31073, 35452, 62082, 176054, 143738, 88219, 84701, 149223, 154072, 153704,
            64142, 162307, 2274, 103524, 60065, 49457, 27256, 78345, 68165, 97764, 161434, 7923,
            80456, 160327, 68312, 141369, 3320, 70363, 175547, 130964, 153206, 169916, 14864,
            10649, 125309, 137285, 106486, 86029, 49411, 104216, 91005, 132351, 107972, 191662,
            37619, 115192, 163836, 103900, 67148, 102287, 113271, 83565, 200491, 3481, 57945,
            136438, 3092, 64798, 129462, 49237, 26407, 161667, 133207, 175326, 75420, 197477,
            22376, 87289, 101958, 124907, 58380, 112374, 97274, 191991, 155243, 136933, 46110,
            85005, 97717, 104095, 200127, 69295, 60278, 174707, 138490, 194893, 109425, 155096,
            193791, 138742, 198922, 154599, 136312, 136397, 182428, 173528, 132348, 135685, 60783,
            200372, 121527, 103666, 191967, 94222, 180491, 16870, 112606, 118022, 106396, 195880,
            178101, 27898, 195867, 200084, 136599, 76707, 10305, 94123, 65964, 20032, 140802,
            197968, 70098, 83585, 111761, 169428, 188833, 161789, 156031, 134824, 169116, 147404,
            123332, 97034, 134166, 25326, 103474, 193923, 30839, 77761, 200306, 60325, 29609,
            159787, 101916, 54519, 50851, 171377, 111066, 37749, 11144, 90591, 157419, 8634,
            166904, 157441, 98465, 15640, 6685, 187177, 49093, 5749, 59, 137498, 73900, 160377,
            145749, 59937, 21637, 103933, 60175, 185532, 64462, 42063, 191758, 139809, 66657,
            167669, 116975, 131287, 155970, 13284, 8530, 64138, 88509, 178141, 95005, 48572, 36761,
            67572, 38994, 92729, 193281, 152972, 49569, 60052, 199497, 27240, 150096, 45987,
            198867, 187938, 37161, 120020, 163401, 127964, 196519, 66601, 143900, 12139, 55812,
            124393, 125498, 48525, 145906, 23752, 190755, 32626, 147083, 161860, 59236, 175952,
            94912, 182360, 97638, 126177, 152910, 98664, 20891, 176430, 90579, 84604, 68564,
            158191, 48494, 121851, 48913, 22698, 54686, 187615, 198059, 146874, 133690, 173776,
            112435, 63160, 58628, 161112, 177777, 180058, 50905, 146017, 92791, 74567, 99867,
            183250, 91110, 105568, 25418, 145531, 18647, 36289, 122786, 195755, 5817, 16594,
            130378, 39581, 84368, 170441, 158866, 19942, 123003, 86336, 108981, 48218, 188011,
            29678, 195863, 29247, 145998, 100696, 74672, 83179, 88203, 186679, 127045, 72945,
            23101, 182351, 61932, 156386, 14277, 31003, 198698, 117118, 158555, 68375, 119518,
            115990, 200232, 42512, 180477, 128576, 5983, 111351, 5657, 76716, 71753, 57285, 84313,
            1027, 149668, 14198, 143614, 63850, 178169, 93585, 188760, 135997, 98718, 24483, 27901,
            715, 173327, 2080, 15927, 44598, 127581, 54014, 118630, 104987, 50192, 157960, 28107,
            181818, 66986, 178367, 142160, 108395, 137075, 131010, 150244, 81613, 155569, 171568,
            86297, 188178, 85157, 160353, 112033, 26670, 80033, 88643, 4507, 128681, 160568, 24135,
            147278, 25226, 137354, 135152, 156811, 196547, 161264, 147835, 98256, 61227, 198353,
            31331, 186393, 166261, 99864, 4434, 146441, 12800, 73775, 143987, 99204, 201749,
            196433, 144536, 160822, 24999, 97757, 190441, 140450, 168034, 39940, 46456, 111640,
            121122, 161988, 48123, 189422, 125477, 182404, 162271, 103130, 100157, 133786, 16051,
            77189, 72583, 58661, 100558, 83558, 145335, 178320, 105274, 17903, 92828, 162674,
            48860, 177227, 107942, 15175, 164969, 176232, 139680, 125601, 37700, 111268, 48015,
            61113, 338, 136912, 12316, 103376, 164853, 148440, 80266, 89232, 86408, 7376, 148019,
            132050, 80391, 103912, 145922, 125867, 145569, 23783, 12251, 87619, 183096, 128560,
            149940, 109899, 22604, 192969, 6631, 82130, 185179, 47325, 122664, 85973, 137585,
            26593, 96844, 187954, 78975, 142198, 7946, 29653, 11464, 19938, 75803, 168594, 54629,
            70214, 171786, 151386, 93480, 142629, 15798, 64711, 82822, 106053, 94135, 145607,
            179190, 115612, 58002, 170437, 150301, 115774, 184675, 60676, 40360, 63402, 186930,
            147578, 64562, 135843, 26241, 111884, 201776, 80541, 90371, 13116, 170737, 34022,
            24729, 174606, 137342, 192101, 38801, 98037, 186604, 123059, 45018, 168254, 131700,
            105814, 176339, 197230, 70616, 125078, 155657, 178566, 169970, 4072, 152745, 48710,
            20411, 52088, 33498, 63667, 100025, 179586, 141510, 116926, 116752, 125093, 35972,
            44178, 91205, 156889, 182444, 179923, 88376, 136299, 37371, 153266, 96682, 112755,
            145669, 14669, 147283, 133800, 107098, 140101, 114163, 36157, 20816, 105184, 134284,
            18765, 108532, 131588, 117135, 21093, 186696, 171954, 8585, 64275, 114865, 19333,
            37026, 110591, 178220, 63670, 76088, 107712, 35919, 42720, 167666, 11384, 408, 14685,
            19619, 155978, 152205, 187364, 123266, 84708, 93370, 191127, 105733, 155839, 44768,
            101744, 7636, 116567, 142671, 136351, 27969, 59078, 17363, 174127, 106976, 111062,
            69665, 28176, 36773, 126882, 157004, 58997, 55403, 143790, 78817, 178681, 63397, 87444,
            160150, 57394, 72301, 25394, 134274, 184466, 132566, 173466, 109517, 28682, 54459,
            169314, 189586, 123908, 164449, 121562, 27154, 5234, 5032, 107935, 81379, 166536,
            52418, 106799, 21638, 111930, 37495, 194991, 93333, 51148, 31897, 35348, 190484,
            182327, 168395, 123119, 174537, 81683, 102238, 10642, 40989, 53373, 120886, 52837,
            139817, 24683, 130259, 75187, 29054, 20937, 12149, 2276, 87566, 190942, 162577, 127503,
            68117, 166041, 149716, 3582, 7395, 139445, 76809, 140624, 198959, 141779, 107099,
            182480, 164126, 143777, 182544, 164104, 195811, 91469, 79649, 142875, 80494, 139155,
            160436, 194842, 65686, 64167, 165585, 163013, 182521, 142442, 88600, 113060, 145110,
            122545, 91164, 133083, 150957, 73805, 107370, 191476, 159604, 45866, 4351, 63632,
            176537, 129815, 71192, 123250, 143053, 134899, 56556, 175331, 29651, 141412, 196850,
            53934, 105233, 103210, 70096, 70408, 43131, 149527, 125472, 74891, 160555, 54821,
            124215, 32416, 65564, 75869, 61707, 11143, 98570, 14803, 91862, 167476, 54019, 100129,
            120282, 82914, 12233, 123961, 147068, 68306, 189243, 124980, 126587, 188217, 8028,
            95375, 137637, 32060, 67546, 1105, 104337, 87053, 35891, 43381, 165125, 192633, 51786,
            173313, 113786, 148586, 131850, 116043, 65854, 193695, 93714, 84242, 162030, 136279,
            196951, 151451, 183104, 4630, 161029, 197790, 62942, 90296, 112378, 56083, 192367,
            7617, 49857, 114319, 34446, 135675, 150195, 96638, 197810, 186056, 16642, 172612,
            29981, 114645, 69081, 162072, 188899, 1727, 7471, 5024, 58598, 70290, 173641, 194851,
            196628, 147567, 152331, 60644, 92935, 19046, 96716, 93325, 71594, 79734, 41328, 139793,
            138659, 116113, 115583, 44787, 98066, 164683, 36536, 110436, 198447, 100962, 164624,
            192272, 93663, 95584, 92050, 167470, 101893, 32857, 196379, 193919, 131195, 173593,
            109949, 136356, 190827, 142041, 44131, 131992, 137667, 74205, 159818, 197437, 40987,
            31844, 168986, 51301, 27628, 19328, 76921, 74659, 186906, 6644, 108810, 197969, 53972,
            59627, 97458, 99732, 43897, 64849, 198238, 55898, 46458, 182034, 73206, 31887, 28642,
            24558, 113869, 138729, 112689, 60547, 55886, 28680, 70417, 14477, 57227, 147958, 73837,
            155688, 33079, 139565, 133094, 104206, 30379, 99013, 103714, 56646, 160756, 91060,
            99012, 6800, 80604, 8841, 15705, 64207, 49178, 186784, 87767, 193144, 29577, 145524,
            30435, 76596, 140811, 75368, 4126, 51674, 92756, 127473, 104734, 70305, 53956, 75499,
            175395, 157224, 145268, 129460, 65195, 112714, 67302, 69846, 66763, 152794, 10463,
            180228, 87817, 128217, 48195, 188674, 11179, 126443, 10231, 33228, 74712, 134607,
            156141, 188831, 177747, 14591, 161386, 56927, 148940, 62365, 148280, 89265, 25854,
            27774, 283,
        ]
    }

    /// convert polynomial to vector
    fn forward_ntt(poly: &Self::Polynomial) -> Self {
        let mut output = poly.coeffs.iter().map(|x| x.0).collect::<Vec<_>>();
        let modulus = <ConfigZZpX202753_512 as ConfigZZpX>::BaseConfig::MODULUS;
        let table = Self::table();

        let mut t = ConfigZZpX202753_512::DIM;
        for l in 0..9 {
            let m = 1 << l;
            let ht = t / 2;
            let mut i = 0;
            let mut j1 = 0;
            while i < m {
                let s = table[m + i];
                let j2 = j1 + ht;
                let mut j = j1;
                while j < j2 {
                    let u = output[j];
                    let v = (output[j + ht] as u64 * s as u64 % modulus as u64) as u32;

                    output[j] = (u + v) % modulus;
                    output[j + ht] = (u + modulus - v) % modulus;
                    j += 1;
                }

                i += 1;
                j1 += t
            }
            t = ht;
        }

        Self::from_primitive_types(&output)
    }

    /// convert the vector to polynomial
    fn reverse_ntt(&self) -> Self::Polynomial {
        let mut output = self.coeffs.iter().map(|x| x.0).collect::<Vec<_>>();
        let modulus = <ConfigZZpX202753_512 as ConfigZZpX>::BaseConfig::MODULUS;
        let inv_table = Self::inv_table();

        let mut t = 1;
        let mut m = ConfigZZpX202753_512::DIM;
        while m > 1 {
            let hm = m / 2;
            let dt = t * 2;
            let mut i = 0;
            let mut j1 = 0;
            while i < hm {
                let j2 = j1 + t;
                let s = inv_table[hm + i];
                let mut j = j1;
                while j < j2 {
                    let u = output[j];
                    let v = output[j + t];
                    output[j] = (u + v) % modulus;
                    let w = (u + modulus - v) % modulus;
                    output[j + t] = (w as u64 * s as u64 % modulus as u64) as u32;
                    j += 1;
                }

                i += 1;
                j1 += dt;
            }
            t = dt;
            m = hm;
        }
        for e in output.iter_mut() {
            *e = (*e as u64 * Self::ONE_OVER_N as u64 % modulus as u64) as u32
        }

        Self::Polynomial::from_primitive_types(&output)
    }
}
